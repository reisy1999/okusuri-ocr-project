# 変更報告書: ファジーマッチングアルゴリズムの置き換え

日付: 2026-02-27

## 1. 背景

OCR で読み取った医薬品名を DB のマスタとマッチングする処理において、
レーベンシュタイン距離ベースのスコアリングを使用していた。
しかし、医薬品名特有の誤読パターン（濁点・半濁点の混同、類似カタカナの取り違え）に
対してレーベンシュタイン距離では適切なスコアが出ず、マッチング精度に問題があった。

## 2. 変更前の問題

### 問題 1: レーベンシュタイン距離が医薬品名の誤読パターンに弱い

レーベンシュタイン距離は「1文字の挿入・削除・置換」を等価に扱うため、
OCR で頻発する濁点・半濁点の取り違え（ブ↔プ、バ↔パ等）が
無関係な文字への置換と同じペナルティを受けていた。

| 入力 | 対象 | Levenshtein | 理想 |
|------|------|-------------|------|
| ブルゼニド | プルゼニド | 0.80 | ≒1.0 |
| デバケン | デパケン | 0.75 | ≒1.0 |
| サイザル | ザイザル | 0.75 | ≒1.0 |

### 問題 2: best_match の組み立てで容量が重複する可能性

`fuzzy-match.ts` は入力を `normalizeMedicineName` で分解し、
`prefix + bestName + suffix` で結果を再構築していた。
しかし DB の `normalized_*` カラムに容量（200mg 等）が残っている場合、
suffix と bestName の両方に容量が含まれ重複する可能性があった。

```
入力: "プルゼニド錠200mg"
→ normalized: "プルゼニド", suffix: "錠200mg"
→ bestName (DB): "プルゼニド200mg"  ← DB側に容量が残っている
→ best_match: "" + "プルゼニド200mg" + "錠200mg" = "プルゼニド200mg錠200mg"  ← 重複
```

## 3. 実施した変更

### 3-1. vwhtfrag アルゴリズムの新規実装

**ファイル:** `ocr-pipeline/src/vwhtfrag.ts`（新規作成）

断片パターン指標（vwhtfrag）アルゴリズムを実装した。
2つの文字列から重なりのない共通部分文字列（断片）を抽出し、
その長さと位置に基づいてスコアを算出する。

主要な機能:

- **濁点・半濁点の同一視**: ガ↔カ、バ↔パ↔ハ 等、清音に統一して比較
- **類似文字ブリッジ**: [シ,ツ] [ソ,ン] [ク,ワ] [ク,ケ] [コ,ユ] [ナ,メ] の6対を定義。
  類似文字自体はスコアに加算せず（C=0.00）、前後の断片を繋ぐブリッジとしてのみ機能
- **位置係数**: 先頭・末尾に一致する断片は係数 1.0、中間部分は 0.45（A パラメータ）
- **連続性ボーナス**: 断片ごとに B=0.15 を減算し、短い断片の乱立にペナルティ
- **完全濁点一致の早期リターン**: 同じ長さで全文字が完全一致または濁点同一視のみで
  一致する場合、B 減算をスキップして 1.0 を返す
- **パラメータ外部調整可能**: A, B, C を `VwhtfragParams` として公開

### 3-2. fuzzy-match.ts の呼び出し切り替え

**ファイル:** `ocr-pipeline/src/fuzzy-match.ts`（変更）

- `normalizedScore`（levenshtein）→ `vwhtfragScore` に切り替え
- 閾値はそのまま維持（≥0.85 unmodified, 0.5-0.85 modified, <0.5 no_match）

### 3-3. 比較用・表示用の正規化を分離

**ファイル:** `ocr-pipeline/src/fuzzy-match.ts`（変更）

- **比較用**: `normalizeMedicineName` で容量・剤形を除去した文字列同士で vwhtfrag 比較
- **表示用**: DB の元の `generic_name` / `brand_name` をそのまま `best_match` に返す
- `prefix + bestName + suffix` の組み立てロジックを廃止し、容量重複の余地を排除

変更前:
```typescript
bestName = med.normalized_generic;       // 比較用の文字列を表示にも使っていた
best_match: prefix + bestName + suffix   // 容量重複のリスク
```

変更後:
```typescript
bestDisplayName = med.generic_name;      // 表示は DB の元表記
best_match: bestDisplayName              // そのまま返す
```

### 3-4. アルゴリズム比較スクリプトの作成

**ファイル:** `ocr-pipeline/src/compare-algorithms.ts`（新規作成）

`npx tsx src/compare-algorithms.ts` で両アルゴリズムのスコアを並べて確認できる。

## 4. 変更後のスコア比較

```
入力              対象              Levenshtein   vwhtfrag      説明
------------------------------------------------------------------------------------------
ロキソニン         ロキソニン         1.0000        1.0000        完全一致
ブルゼニド         プルゼニド         0.8000        1.0000        濁点半濁点 (ブ→プ)
エスゾビクロン      エスゾピクロン      0.8571        1.0000        濁点半濁点 (ビ→ピ)
デバケン          デパケン          0.7500        1.0000        濁点半濁点 (バ→パ)
ファモチワン       ファモチジン        0.8333        0.7833        類似文字 (ワ→ジ) + 濁点
サイザル          ザイザル          0.7500        1.0000        位置入れ替え
```

## 5. 変更ファイル一覧

| ファイル | 操作 |
|---------|------|
| `ocr-pipeline/src/vwhtfrag.ts` | 新規作成 |
| `ocr-pipeline/src/fuzzy-match.ts` | 変更（vwhtfrag 切り替え + 表示用分離） |
| `ocr-pipeline/src/compare-algorithms.ts` | 新規作成 |
| `ocr-pipeline/src/levenshtein.ts` | 変更なし（比較テスト用に保持） |

## 6. 残課題

- 閾値の再調整（vwhtfrag のスコア分布に合わせた最適値の検討）
- DB の `normalized_*` カラムが正規化不十分な場合のデータクレンジング
- 長い薬品名に対する extractFragments の再帰探索のパフォーマンス検証
